# bird2.nvim GitHub Actions CI Workflow
name: CI

on:
  push:
    branches: ["main", "develop"]
    paths: ["lua/**", "tests/**", ".github/workflows/**"]
  pull_request:
    branches: ["main"]
    paths: ["lua/**", "tests/**"]
  workflow_dispatch:

jobs:
  lua-lint:
    name: Lua Lint (luacheck)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LuaRocks
        run: |
          sudo apt-get update
          sudo apt-get install -y luarocks

      - name: Install luacheck
        run: |
          luarocks install luacheck

      - name: Run luacheck
        run: |
          luacheck lua/

  type-check:
    name: Lua Type Check (lua-language-server)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install lua-language-server
        run: |
          npm install -g lua-language-server

      - name: Run type check
        run: |
          lua-language-server --check=lua/ --checklevel=Information --configpath=.luarc.json
        continue-on-error: true

  tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Lua
        run: |
          sudo apt-get update
          sudo apt-get install -y lua5.1 luarocks

      - name: Install busted test framework
        run: |
          luarocks install busted
          luarocks install luacov

      - name: Run tests
        run: |
          busted --coverage
        continue-on-error: true

  stylua-check:
    name: Lua Format Check (stylua)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install stylua
        uses: JohnnyMorganz/stylua-action@v4
        with:
          version: latest

      - name: Check formatting
        run: |
          stylua --check lua/
        continue-on-error: true
